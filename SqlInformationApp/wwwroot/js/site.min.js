"use strict";$(document).ready(function(){function f(n){let t=$(n);if(t.length===0){alert(`programming issue.. required selector [${n}] returned zero`);throw"jQuery selector not found in dom";}return $(t)}function e(n){let t=ko.observable(n);return t.hasError=ko.observable(!1),t.errorText=ko.observable(""),t}function t(n,t,i,r){let u={};u.method=t;u.headers={accept:"application/json, text/plain, */*","content-type":"application/json"};u.body=r?JSON.stringify(i):r;let f;fetch(n,u).then(n=>(f=n,n.json())).then(n=>{r?r(n,f):i(n,f)}).catch(function(n){console.log(n);alert("fetch went wroong.. see console log")})}let h=[],r=ko.observableArray([]),u=!0;t("clientsettings.json","GET",function(){});t("api/TableSchemas","GET",function(n){n.forEach(function(n){n.cardClass=ko.observable("");n.isSelectedQueryTable=ko.observable(!1);n.isPrimaryQueryTable=ko.observable(!1);n.isJoinedQueryTable=ko.observable(!1);n.excludeFromQuery=ko.observable(!1);n.selectedTableSeq=ko.observable(1);n.parentTableSeq=ko.observable(0);h.push(n)});f("#nav-info-tab").trigger("click")});let s=undefined;f("#nav-info-tab").on("click",function(){function n(n,t){function f(n){if(n.isSelectedQueryTable()===!1){n.cardClass("");return}let t=n.parentTableSeq();n.isPrimaryQueryTable()===!0?n.cardClass("flip-card-selected"):n.cardClass(t===1?"flip-card-related1":"flip-card-related2")}function h(n){n.isPrimaryQueryTable(!1);let u=ko.utils.arrayFirst(t(),function(t){return t.table_name===n.table_name});u?i.infoTables.forEach(function(i){let u=`${i.table_schema}.${i.table_name}`;n.fkList.indexOf(u)>-1&&(r++,i.selectedTableSeq(r),i.parentTableSeq(n.selectedTableSeq()),i.isPrimaryQueryTable(!1),i.isSelectedQueryTable(!0),i.isJoinedQueryTable(!0),f(i),t.push(i))}):(r++,n.selectedTableSeq(r),n.isSelectedQueryTable(!0),n.isJoinedQueryTable(!1),n.cardClass("flip-card-nolink"),t.push(n));return}function c(n){r=1;o=!0;t([]);n.isPrimaryQueryTable(!0);n.isSelectedQueryTable(!0);n.isJoinedQueryTable(!1);n.selectedTableSeq(r);t.push(n);i.infoTables.forEach(function(i){let u=`${i.table_schema}.${i.table_name}`,e=`${n.table_schema}.${n.table_name}`;u!==e&&(n.fkList.indexOf(u)>-1?(r++,i.selectedTableSeq(r),i.parentTableSeq(n.selectedTableSeq()),i.isPrimaryQueryTable(!1),i.isSelectedQueryTable(!0),i.isJoinedQueryTable(!0),f(i),t.push(i)):f(i))});f(n)}const i=this;let s=[],e=undefined,o=!1,r=888;n.forEach(function(n){s.push(n.table_schema)});i.infoSchemas=[...new Set(s)];i.infoTables=n;i.setSchemaContext=function(n){return e=n};i.getTables=function(){return i.infoTables.filter(function(n){return n.table_schema===e})};i.onTableClick=function(n){o?h(n):c(n)};i.onLockClick=function(n){i.onTableClick(n,null)};i.onResetQueryClick=function(){u=!0;t([]);o=!1;i.infoTables.forEach(function(n){n.isPrimaryQueryTable(!1);n.isSelectedQueryTable(!1);n.isJoinedQueryTable(!1);f(n)})}}(location.hash="info",s)||(s=new n(h,r),ko.applyBindings(s,document.getElementById("nav-info-partial")))});let n=undefined;f("#nav-query-tab").on("click",function(){function i(n){let i=this;i.isNewMode=ko.observable(!0);i.queryTables=ko.observableArray();i.queryId=undefined;i.needsRefresh=ko.observable(!1);i.queryName=e("");i.queryName.subscribe(function(){i.isNewMode(!0)});i.rowsExpectedMax=e(100);i.rowsExpectedMax.subscribe(function(){});i.sqlSelectStatement=e("");i.onSaveNamedQuery=function(){if(i.queryName()===""){i.queryName.hasError(!0);i.queryName.errorText("provide a unique query-name");return}u=!1;let r={queryId:i.queryId,queryName:i.queryName(),queryTableBase:n()[0].querySchemaPlusTable,querySql:i.sqlSelectStatement(),queryRowsExpected:i.rowsExpectedMax()};i.isNewMode()?t("/api/Queries/InsertNamedQuery","POST",r,function(n,t){t.status!==200?(i.queryName.hasError(!0),i.queryName.errorText(n.appErrorText)):(i.queryName.hasError(!1),i.queryId=n.result);i.isNewMode(i.queryName.hasError())}):t("/api/Queries/UpdateNamedQuery","PUT",r,function(n,t){t.status!==200?(i.queryName.hasError(!0),i.queryName.errorText(n.appErrorText)):i.queryName.hasError(!1)})};i.onRefreshSQL=function(){let n=[];ko.utils.arrayForEach(i.queryTables(),function(t){if(t.excludeFromQuery()===!1){let i=t.columnList.filter(n=>!t.columnListX.includes(n));n.push({JoinOn:t.queryConditions(),IsBaseTable:t.isPrimaryQueryTable(),TableName:t.querySchemaPlusTable,IncludeColumns:i,FkTableNames:t.fkList,PkColumnNames:t.pkNames})}});t("/api/Queries/MakeSqlQueryString","POST",n,function(n,t){t.ok?(i.sqlSelectStatement(n.fullSql),i.needsRefresh(!1),i.sqlSelectStatement.hasError(!1)):(i.sqlSelectStatement.hasError(!0),i.sqlSelectStatement.errorText("sql statement failed -- check syntax of each table conditions"))})};i.onGetResult=function(){let n={sqlQueryStatement:i.sqlSelectStatement(),rowsExpectedMax:i.rowsExpectedMax()};t("/api/Queries/RunSqlQuery","PUT",n,function(n,t){t.ok?(n.queryResult.length>i.rowsExpectedMax()?(i.rowsExpectedMax.hasError(!0),i.rowsExpectedMax.errorText("query returns more than expected")):i.rowsExpectedMax.hasError(!1),console.log(n)):(i.rowsExpectedMax.hasError(!0),i.rowsExpectedMax.errorText("query may have timed out.. try again"))})};i.setQueryView=function(n){i.queryTables([]);i.queryName("");ko.utils.arrayForEach(n(),function(n){n.queryTable=n.table_name;n.querySchemaPlusTable=n.table_schema+"."+n.table_name;n.queryId=n.table_name;n.queryTitle=n.querySchemaPlusTable+" "+(n.isPrimaryQueryTable()?"(primary)":"(include/join)");n.queryConditions=e("");n.queryConditions.subscribe(function(){i.needsRefresh(!0)});i.queryTables.push(n)})};i.loadTablesData=function(){const n="cell-header-excluded";ko.utils.arrayForEach(i.queryTables(),function(t){let u=[];t.columnList.forEach(function(n){u.push({data:n,title:n,"class":"cell-nowrap"})});let r=$("table#"+t.queryId).DataTable({destroy:!0,paging:!1,searching:!1,info:!1,ordering:!1,scrollX:!0,autoWidth:!0,responsive:!0,ajax:{url:`/api/Queries/${t.querySchemaPlusTable}`,data:{isPrimary:t.isPrimaryQueryTable()},dataSrc:""},columns:u}),f=r.columns().header().toArray();$(f).on("click",function(f){f.preventDefault();i.needsRefresh(!0);let s=r.column(this).index(),o=u[s],e=r.column($(this)).header();e.classList.contains(n)?(e.classList.remove(n),t.columnListX.pop(o.data)):(e.classList.add(n),t.columnListX.push(o.data));r.draw()});r.on("click","td",function(){i.needsRefresh(!0);let u=r.cell(this).data(),o=r.cell(this).index().column,n=f[o].innerHTML;n="*."+n;let e=t.queryConditions();e===""?t.queryConditions(`${n} = '${u}'`):t.queryConditions(`${e} & ${n} = '${u}'`)})})};i.setQueryView(n,u)}if(r().length===0)return alert("pick a table to get started"),!1;if(location.hash="query",n){u&&(n.setQueryView(r,u),n.onRefreshSQL(),n.loadTablesData());$("table").resize();return}n=new i(r);ko.applyBindings(n,document.getElementById("nav-query-partial"));n.onRefreshSQL();n.loadTablesData();$("table").resize()});let i=undefined;f("#nav-code-tab").on("click",function(r,u){function f(){let n=this;n.queryName=ko.observable("");n.queryColumns=ko.observableArray([]);n.queryTypes=ko.observableArray([]);n.runFooBarQuery=function(){t("/api/foobars?queryName="+n.queryName(),"GET",function(n){console.log(n)})};n.setQueryName=function(i){n.queryName(i);t("/api/Queries/GetQuerySchema?namedQuery="+n.queryName(),"GET",function(t,i){i.ok&&(n.queryColumns(t.querySchema.queryColumns),n.queryTypes(t.querySchema.queryDataTypes))})};n.getJsonFormat=function(n){return n.charAt(0).toLowerCase()+n.slice(1)}}if(u){if(i){i.setQueryName(u);return}}else{if(!n||n.isNewMode())return alert("name and save your query before viewing code"),!1;if(i){i.setQueryName(n.queryName());return}}location.hash="code";i=new f;i.setQueryName(u?u:n.queryName());ko.applyBindings(i,document.getElementById("nav-code-partial"))});let o=undefined;f("#nav-lib-tab").on("click",function(){function n(){let n=this;n.queries=ko.observableArray([]);n.onSaveQueryClick=function(n){let i={queryId:n.QueryId,QueryName:n.QueryName,queryRowsExpected:n.QueryRowsExpected,QuerySql:n.QuerySql};t("/api/Queries/UpdateSavedQuery","PUT",i,function(n,t){t.status!==200})};n.onRefreshClick=function(){n.loadAllQueries()};n.onSqlClick=function(t){let i=t.isExpanded();ko.utils.arrayForEach(n.queries(),function(n){n.isExpanded(!1)});t.isExpanded(!i)};n.onRunSqlClick=function(n){t("/api/foobars?queryName="+n.QueryName,"GET",function(t,i){if(i.ok){var r=JSON.stringify(t).replace(/[\[\]\,\"]/g,"");n.rowCountActual(t.length);n.rowCountActual.hasError(t.length>n.rowCountExpected());n.rowCountActual.errorText("query returns more rows than expected");n.rowSize(r.length);i.ok&&console.log(t)}})};n.onSeeCodeClick=function(n){$("#nav-code-tab").trigger("click",n.QueryName)};n.loadAllQueries=function(){t("api/queries","GET",function(t,i){i.ok&&(t.forEach(function(n){n.isExpanded=ko.observable(!1);n.rowCountExpected=ko.observable(n.QueryRowsExpected);n.rowCountActual=e(0);n.rowSize=ko.observable(0);n.elapseTime=ko.observable(0)}),n.queries(t))})}}(location.hash="library",o)||(o=new n(r),o.loadAllQueries(),ko.applyBindings(o,document.getElementById("nav-lib-partial")))})});