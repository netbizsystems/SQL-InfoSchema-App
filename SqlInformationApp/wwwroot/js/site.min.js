"use strict";$(document).ready(function(){function u(n){let t=$(n);if(t.length===0){alert(`programming issue.. required selector [${n}] returned zero`);throw"jQuery selector not found in dom";}return $(t)}function e(n){let t=ko.observable(n);return t.hasError=ko.observable(!1),t.errorText=ko.observable(""),t}function t(n,t,i,r){let u={};u.method=t;u.headers={accept:"application/json, text/plain, */*","content-type":"application/json"};u.body=r?JSON.stringify(i):r;let f;fetch(n,u).then(n=>(f=n,n.json())).then(n=>{r?r(n,f):i(n,f)}).catch(function(n){console.log(n);alert("fetch went wroong.. see console log")})}let s=[],r=ko.observableArray([]);t("clientsettings.json","GET",function(){});t("api/TableSchemas","GET",function(n){n.forEach(function(n){n.cardClass=ko.observable("");n.isSelectedQueryTable=ko.observable(!1);n.isPrimaryQueryTable=ko.observable(!1);n.isJoinedQueryTable=ko.observable(!1);n.excludeFromQuery=ko.observable(!1);n.selectedTableSeq=ko.observable(1);n.parentTableSeq=ko.observable(0);s.push(n)});u("#nav-info-tab").trigger("click")});let o=undefined;u("#nav-info-tab").on("click",function(){function n(n,t){function u(n){if(n.isSelectedQueryTable()===!1){n.cardClass("");return}let i=n.selectedTableSeq(),t=n.parentTableSeq();n.isPrimaryQueryTable()===!0?n.cardClass("flip-card-selected"):n.cardClass(t===1?"flip-card-related1":"flip-card-related2")}function s(n){n.isPrimaryQueryTable(!1);let f=ko.utils.arrayFirst(t(),function(t){return t.table_name===n.table_name});f?i.infoTables.forEach(function(i){let f=`${i.table_schema}.${i.table_name}`;n.fkList.indexOf(f)>-1&&(r++,i.selectedTableSeq(r),i.parentTableSeq(n.selectedTableSeq()),i.isPrimaryQueryTable(!1),i.isSelectedQueryTable(!0),i.isJoinedQueryTable(!0),u(i),t.push(i))}):(r++,n.selectedTableSeq(r),n.isSelectedQueryTable(!0),n.isJoinedQueryTable(!1),n.cardClass("flip-card-nolink"),t.push(n));return}function h(n){r=1;e=!0;t([]);n.isPrimaryQueryTable(!0);n.isSelectedQueryTable(!0);n.isJoinedQueryTable(!1);n.selectedTableSeq(r);t.push(n);i.infoTables.forEach(function(i){let f=`${i.table_schema}.${i.table_name}`,e=`${n.table_schema}.${n.table_name}`;f!==e&&(n.fkList.indexOf(f)>-1?(r++,i.selectedTableSeq(r),i.parentTableSeq(n.selectedTableSeq()),i.isPrimaryQueryTable(!1),i.isSelectedQueryTable(!0),i.isJoinedQueryTable(!0),u(i),t.push(i)):u(i))});u(n)}const i=this;let o=[],f=undefined,e=!1,r=888;n.forEach(function(n){n.cardClass=ko.observable("");n.isSelectedQueryTable=ko.observable(!1);n.isPrimaryQueryTable=ko.observable(!1);n.isJoinedQueryTable=ko.observable(!1);n.excludeFromQuery=ko.observable(!1);n.selectedTableSeq=ko.observable(1);n.parentTableSeq=ko.observable(0);o.push(n.table_schema)});i.infoTables=n;i.infoSchemas=[...new Set(o)];i.setSchemaContext=function(n){return f=n};i.getTables=function(){return i.infoTables.filter(function(n){return n.table_schema===f})};i.onTableClick=function(n){e?s(n):h(n)};i.onLockClick=function(n){i.onTableClick(n,null)};i.onResetQueryClick=function(){t([]);e=!1;i.infoTables.forEach(function(n){n.isPrimaryQueryTable(!1);n.isSelectedQueryTable(!1);n.isJoinedQueryTable(!1);u(n)})}}o||(o=new n(s,r),ko.applyBindings(o,document.getElementById("nav-info-partial")))});let n=undefined;u("#nav-query-tab").on("click",function(){function i(n){let i=this;i.isNewMode=ko.observable(!0);i.queryTables=ko.observableArray();i.sqlSelectStatement=ko.observable("");i.queryPk=undefined;i.needsRefresh=ko.observable(!1);i.queryName=e("");i.queryName.subscribe(function(){i.isNewMode(!0)});i.rowsExpectedMax=e(100);i.rowsExpectedMax.subscribe(function(){});i.onSaveNamedQuery=function(){if(i.queryName()===""){i.queryName.hasError(!0);i.queryName.errorText("provide a unique query-name");return}let r={queryPk:i.queryPk,queryName:i.queryName(),queryTableBase:n()[0].querySchemaPlusTable,querySql:i.sqlSelectStatement(),rowsExpected:i.rowsExpectedMax()};i.isNewMode()?t("/api/Queries/InsertNamedQuery","POST",r,function(n,t){t.status!==200?(i.queryName.hasError(!0),i.queryName.errorText(n.appErrorText)):(i.queryName.hasError(!1),i.queryPk=n.result);i.isNewMode(i.queryName.hasError())}):t("/api/Queries/UpdateNamedQuery","PUT",r,function(n,t){t.status!==200?(i.queryName.hasError(!0),i.queryName.errorText(n.appErrorText)):i.queryName.hasError(!1)})};i.onRefreshSQL=function(){let n=[];ko.utils.arrayForEach(i.queryTables(),function(t){if(t.excludeFromQuery()===!1){let i=t.columnList.filter(n=>!t.columnListX.includes(n));n.push({JoinOn:t.queryConditions(),IsBaseTable:t.isPrimaryQueryTable(),TableName:t.querySchemaPlusTable,IncludeColumns:i,FkTableNames:t.fkList,PkColumnNames:t.pkNames})}});t("/api/Queries/MakeSqlQueryString","POST",n,function(n){i.sqlSelectStatement(n.fullSql);i.needsRefresh(!1)})};i.onGetResult=function(){let n={sqlQueryStatement:i.sqlSelectStatement(),rowsExpectedMax:i.rowsExpectedMax()};t("/api/Queries/RunSqlQuery","PUT",n,function(n,t){t.ok?(n.queryResult.length>i.rowsExpectedMax()?(i.rowsExpectedMax.hasError(!0),i.rowsExpectedMax.errorText("query returns more than expected")):i.rowsExpectedMax.hasError(!1),console.log(n)):(i.rowsExpectedMax.hasError(!0),i.rowsExpectedMax.errorText("query may have timed out.. try again"))})};i.setQueryView=function(n){i.queryTables([]);i.queryName("");ko.utils.arrayForEach(n(),function(n){n.queryTable=n.table_name;n.querySchemaPlusTable=n.table_schema+"."+n.table_name;n.queryId=n.table_name;n.queryTitle=n.querySchemaPlusTable+" "+(n.isPrimaryQueryTable()?"(primary)":"(include/join)");n.queryConditions=e("");n.queryConditions.subscribe(function(){i.needsRefresh(!0)});i.queryTables.push(n)})};i.loadTablesData=function(){const n="cell-header-excluded";ko.utils.arrayForEach(i.queryTables(),function(t){let u=[];t.columnList.forEach(function(n){u.push({data:n,title:n,"class":"cell-nowrap"})});let r=$("table#"+t.queryId).DataTable({destroy:!0,paging:!1,searching:!1,info:!1,ordering:!1,scrollX:!0,autoWidth:!0,responsive:!0,ajax:{url:`/api/Queries/${t.querySchemaPlusTable}`,data:{isPrimary:t.isPrimaryQueryTable()},dataSrc:""},columns:u}),f=r.columns().header().toArray();$(f).on("click",function(f){f.preventDefault();i.needsRefresh(!0);let s=r.column(this).index(),o=u[s],e=r.column($(this)).header();e.classList.contains(n)?(e.classList.remove(n),t.columnListX.pop(o.data)):(e.classList.add(n),t.columnListX.push(o.data));r.draw()});r.on("click","td",function(){i.needsRefresh(!0);let u=r.cell(this).data(),o=r.cell(this).index().column,n=f[o].innerHTML;n="*."+n;let e=t.queryConditions();e===""?t.queryConditions(`${n} = '${u}'`):t.queryConditions(`${e} & ${n} = '${u}'`)})})};i.setQueryView(n,!1)}if(r().length===0)return alert("pick a table to get started"),!1;if(n){n.setQueryView(r,!0);n.onRefreshSQL();n.loadTablesData();$("table").resize();return}n=new i(r);ko.applyBindings(n,document.getElementById("nav-query-partial"));n.onRefreshSQL();n.loadTablesData();$("table").resize()});let i=undefined;u("#nav-code-tab").on("click",function(r,u){function f(){let n=this;n.queryName=ko.observable("");n.queryColumns=ko.observableArray([]);n.runFooBarQuery=function(){t("/api/foobars?queryName="+n.queryName(),"GET",function(n){console.log(n)})};n.setQueryName=function(i){n.queryName(i);t("/api/Queries/GetQuerySchema?namedQuery="+n.queryName(),"GET",function(t,i){i.ok&&n.queryColumns(t.foo.queryColumns)})}}if(u){if(i){i.setQueryName(u);return}}else{if(!n||n.isNewMode())return alert("name and save your query before viewing code"),!1;if(i){i.setQueryName(n.queryName());return}}i=new f;i.setQueryName(u?u:n.queryName());ko.applyBindings(i,document.getElementById("nav-code-partial"))});let f=undefined;u("#nav-lib-tab").on("click",function(){function n(){let n=this;n.queries=ko.observableArray([]);n.onRefreshClick=function(){n.loadAllQueries()};n.onSqlClick=function(t){let i=t.isExpanded();ko.utils.arrayForEach(n.queries(),function(n){n.isExpanded(!1)});t.isExpanded(!i)};n.onRunSqlClick=function(n){t("/api/foobars?queryName="+n.QueryName,"GET",function(t,i){if(i.ok){var r=JSON.stringify(t).replace(/[\[\]\,\"]/g,"");n.rowCountActual(t.length);n.rowCountActual.hasError(t.length>n.rowCountExpected());n.rowCountActual.errorText("query returns more rows than expected");n.rowSize(r.length);i.ok&&console.log(t)}})};n.onSeeCodeClick=function(n){$("#nav-code-tab").trigger("click",n.QueryName)};n.loadAllQueries=function(){t("api/queries","GET",function(t,i){i.ok&&(t.forEach(function(n){n.isExpanded=ko.observable(!1);n.rowCountExpected=ko.observable(n.QueryRowsExpected);n.rowCountActual=e(0);n.rowSize=ko.observable(0);n.elapseTime=ko.observable(0)}),n.queries(t))})}}f||(f=new n(r),f.loadAllQueries(),ko.applyBindings(f,document.getElementById("nav-lib-partial")))})});